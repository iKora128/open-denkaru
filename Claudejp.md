# CLAUDE.md

このファイルは、このリポジトリのコードを扱う際のClaude Code (claude.ai/code) へのガイダンスを提供します。

## プロジェクト概要

これは「オープン電カル」、日本の医療機関向けに特別に設計されたオープンソース電子カルテ（EMR）システムです。このプロジェクトは、OpenEMRなどの既存ソリューションの制限に対処し、日本の医療規制と実践との完全な互換性を提供する、現代的で開発者フレンドリーなEMRの構築を目指しています。

## プロジェクトの主要目標
- 簡単な変更と拡張機能を備えた開発者ファーストの設計
- 選択的機能採用を可能にするモジュラーアーキテクチャ
- 日本の医療規制（レセプト、保険診療など）への完全準拠
- GitHub中心のコミュニティ主導開発

## 開発環境

### パッケージ管理
- **uv**: Pythonパッケージマネージャー（pip/poetryより推奨）
- 一般的なコマンド:
  ```bash
  uv sync                    # 依存関係のインストール
  uv run python -m mypackage # Pythonモジュールの実行
  uv add <package>          # 依存関係の追加
  ```

### プロジェクト構造
- **docs/research/**: 詳細な要件と研究文書を含む
  - `chatgpt-search.md`: 6段階開発計画を含む包括的要件文書
  - `claude-search.md`: 技術仕様とアーキテクチャの詳細
- **pyproject.toml**: 現代的な標準を使用したPythonプロジェクト設定

## 開発フェーズ（ロードマップ）

### フェーズ1: PoC（概念実証）
- 基本的な患者登録と管理
- シンプルな診療記録入力（SOAP形式）
- ユーザー認証と基本ナビゲーション
- 単一ユーザー操作（複雑な認証はまだなし）

### フェーズ2: 基本機能
- 強化されたデータ永続化（PostgreSQL/MySQL）
- 患者検索とソート
- SOAP構造化診療記録UI
- 基本的な処方箋と検査オーダー入力
- シンプルな処方箋フォーム出力

### フェーズ3: マルチユーザーとセキュリティ
- ユーザー認証とロールベースアクセス制御
- 監査ログと操作追跡
- セキュリティ強化（HTTPS、セキュリティヘッダー）
- データバックアップメカニズム

### フェーズ4: ORCA連携
- ORCA（日本医師会標準レセプトソフト）との統合
- 自動請求データ交換
- 医療費計算ルール準拠
- 患者保険情報同期

### フェーズ5: 標準準拠
- HL7 FHIR API実装
- SS-MIX2標準ストレージサポート
- 地域医療ネットワーク接続
- 検査・画像システム統合

### フェーズ6: AI強化（オプション）
- 医療画像AI解析統合
- 音声入力とNLPサポート
- 臨床意思決定支援AI
- 予測分析

## 技術スタック（2025年現代標準）

### フロントエンドアーキテクチャ決定

**🎯 本番対応選択**: 医療EMR/EHR本番システムを分析した結果、**実績のある技術**を選択し、最大の堅牢性と開発速度を実現します：

#### 主要フロントエンドフレームワーク: **Next.js 14 + React 18**
- **実績**: 本番医療システムで実証済み（Tensor EMR、複数の医療プラットフォーム）
- **堅牢なエコシステム**: 豊富な医療ライブラリ、UIコンポーネント、ツール
- **開発速度**: ホットリロード、自動ルーティングによる迅速な開発
- **パフォーマンス**: 医療設定で重要な高速読み込み時間のためのサーバーサイドレンダリング
- **セキュリティ**: HIPAA/GDPR準拠機能が確立済み
- **相互運用性**: 強力なHL7 FHIR統合ライブラリが利用可能

#### 安定版を選ぶ理由（Next.js 14 + React 18）
- **医療グレードの信頼性**: 完全に安定したAPI、破壊的変更なし
- **豊富なテスト**: 本番医療環境で実戦テスト済み
- **ライブラリ互換性**: 完全なエコシステムサポート、互換性問題なし
- **長期サポート**: ミッションクリティカルな医療システムの安定性保証

### 技術要件（2025年標準）

**常に最新の安定版と現代的なAPIを使用:**

#### バックエンド（実績のあるスタック）
- **Python 3.11+**（安定、優れたパフォーマンス）
- **FastAPI 0.110+**（医療システムで実証済み、優れたOpenAPIドキュメント）
- **SQLAlchemy 2.0+**（非同期サポート付きの成熟したORM）
- **Pydantic v2**（堅牢なデータ検証、広く採用）
- **PostgreSQL 15+**（堅実、医療データのACID準拠）
- **Redis 7.0+**（安定したキャッシュ、セッション管理）
- **Alembic**（信頼性の高いデータベースマイグレーション）

#### フロントエンド（医療グレードスタック）
- **Next.js 14**（安定したApp Router、実証済みSSRパフォーマンス）
- **React 18**（完全に安定、豊富な医療ライブラリエコシステム）
- **TypeScript 5.3+**（成熟、優れたIDE支援）
- **React Query v4**（実戦テスト済みデータフェッチング）
- **Zustand**（軽量、信頼性の高い状態管理）
- **React Hook Form**（医療フォームの高性能フォーム処理）

#### UIとスタイリング（本番対応）
- **Tailwind CSS 3.4+**（安定したユーティリティファーストCSS）
- **Headless UI**（Tailwindチームによるアクセシブルコンポーネント）
- **Radix UI**（複雑な医療UIのための堅牢なプリミティブ）
- **React ARIA**（医療準拠のためのAdobeのアクセシビリティライブラリ）
- **Framer Motion**（スムーズなUXのための安定したアニメーション）

#### インフラストラクチャ（本番実証済み）
- **Docker 24.0+**（安定したLTS、広く展開）
- **Docker Compose**（ほとんどのケースでシンプルなオーケストレーション）
- **Nginx 1.24+**（堅実なリバースプロキシ/ロードバランサー）
- **GitHub Actions**（成熟したCI/CD、優れたエコシステム）
- **Prometheus 2.45+** + **Grafana 10.0+**（業界標準監視）
- **PostgreSQL**ネイティブレプリケーション（組み込みHA解決策）

#### AI/ML統合（安定・信頼性）
- **Ollama**（ローカルLLM展開、本番対応）
- **OpenAI API**（重要機能のフォールバック）
- **scikit-learn**（実戦テスト済みMLライブラリ）
- **PyTorch 2.0+**（安定したLTS、豊富な医療AI使用）
- **Transformers 4.30+**（実証済みHugging Faceライブラリ）
- **ONNX Runtime**（最適化された推論、Microsoft支援）

#### 開発ツール（実証済みワークフロー）
- **uv**（現代的なPythonパッケージ管理）
- **npm**または**pnpm**（安定したNode.jsパッケージ管理）
- **ESLint 8.x**（安定したリンティング）
- **Prettier 3.x**（一貫したコードフォーマット）
- **Husky**（Gitフック）
- **Jest**（実戦テスト済みテストフレームワーク）
- **Playwright**（信頼性の高いE2Eテスト）

## 日本の医療規制準拠

システムは以下に準拠する必要があります：
- **電子カルテ3原則**: 真正性、見読性、保存性
- **医療情報システムの安全管理に関するガイドライン第6.0版**
- **個人情報保護法**
- 保険請求のための**ORCA連携**
- データ交換のための**SS-MIX2**標準

## 開発ガイドライン

### コード標準
- Python PEP 8スタイルガイドラインに従う
- フロントエンドでTypeScript厳密モードを使用
- 包括的なエラーハンドリングを実装
- すべての医療データ操作の監査証跡を維持
- 機密医療情報やAPIキーをコミットしない

### セキュリティ要件
- すべての医療データ操作をログ記録
- ロールベースアクセス制御を実装
- 機密データに適切な暗号化を使用
- ゼロトラストセキュリティモデル原則に従う

### ドキュメント
- OpenAPI/SwaggerですべてのAPIエンドポイントを文書化
- 最新のアーキテクチャ図を維持
- 日本の規制への準拠マッピングを文書化
- 医療環境向けの明確なセットアップ手順を提供

## 品質保証とテスト標準

### 必須テストプロトコル
**重要**: すべての開発作業は展開前にこのテストプロトコルに従う必要があります：

1. **ビルド検証（必須）**
   ```bash
   # フロントエンドビルド検証
   npm run build
   # TypeScriptエラーなしで正常に完了する必要があります
   
   # バックエンドビルド検証
   uv run pytest
   # すべてのテストが合格する必要があります
   ```

2. **コード品質チェック（必須）**
   ```bash
   # フロントエンドリンティング
   npm run lint
   # エラーゼロ、警告は許容
   
   # 型チェック
   npm run type-check
   # 型エラーなしで合格する必要があります
   
   # バックエンドリンティング
   uv run ruff check .
   uv run mypy .
   # すべてのチェックに合格する必要があります
   ```

3. **パフォーマンステスト（必須）**
   - フロントエンドページは2秒以内に読み込み
   - 標準クエリのAPI応答は500ms以内
   - データベースクエリの最適化（患者検索は100ms以内）

4. **セキュリティ検証（必須）**
   - すべてのAPIエンドポイントに適切な認証
   - すべてのフォームで入力検証
   - SQLインジェクション防止の検証
   - XSS保護の検証

### 開発ワークフロー要件

**コミットやプルリクエストの前に:**

1. **ローカルテストスイート**
   ```bash
   # 完全テストスイートの実行
   npm run build && npm run lint && npm run type-check
   uv run pytest && uv run ruff check . && uv run mypy .
   ```

2. **手動検証**
   - 開発サーバーを起動してコア機能を確認
   - 少なくとも3つの重要なユーザーフロー（患者登録、診療記録入力、処方箋）をテスト
   - モバイルとデスクトップでレスポンシブデザインを確認
   - JavaScriptエラーのコンソールチェック

3. **パフォーマンスベンチマーク**
   - ダッシュボード読み込み時間: 2秒以内
   - 患者検索応答: 500ms以内
   - フォーム送信フィードバック: 300ms以内

### ゼロトレランス標準

**以下の問題は即座に却下されます:**

1. **ビルド失敗**: コンパイル/ビルドが正常に完了しないコード
2. **型エラー**: TypeScriptコンパイルエラー
3. **重大なセキュリティ欠陥**: 未検証入力、秘密情報の露出、SQLインジェクションリスク
4. **パフォーマンス低下**: 3秒以上のページ読み込み、1秒以上のAPI応答
5. **医療データ整合性**: 患者記録を破損させる可能性のあるコード

### 医療システムのテスト哲学

**医療グレードの信頼性**:
- **99.9%稼働時間目標**: 24時間365日の医療業務に信頼性が必要
- **データ整合性**: データ破損や損失に対するゼロトレランス
- **ユーザー安全**: 検証と確認によって医療エラーを防ぐUI
- **監査準拠**: すべての行動をログ記録し追跡可能
- **負荷下でのパフォーマンス**: 100人以上の同時ユーザーを処理

**医療のテストピラミッド**:
1. **ユニットテスト（70%）**: 医療データを扱うすべての関数
2. **統合テスト（20%）**: APIエンドポイントとデータベース相互作用
3. **E2Eテスト（10%）**: 重要な臨床ワークフロー
4. **手動テスト**: ユーザビリティと臨床ワークフローの検証

### 展開準備チェックリスト

**本番展開前に:**

- [ ] すべての自動テストが合格（100%）
- [ ] パフォーマンスベンチマークを満たす
- [ ] セキュリティスキャン完了（重大な脆弱性なし）
- [ ] 臨床チームによる医療ワークフロー検証
- [ ] バックアップと復旧手順のテスト
- [ ] 監視とアラートの設定
- [ ] HIPAA準拠監査完了（患者データ用）
- [ ] ドキュメント更新（APIドキュメント、ユーザーガイド）

### 医療緊急プロトコル

**重要な本番問題について:**

1. **即座の対応**（5分以内）
   - 患者の安全がリスクにある場合、影響を受けるシステムをオフライン
   - 医療スタッフにシステム状況を通知
   - バックアップ手順を起動

2. **調査と修正**（30分以内）
   - 根本原因を特定
   - 緊急パッチを実装
   - ステージング環境で修正をテスト

3. **復旧と事後検証**（2時間以内）
   - 検証済み修正を本番に展開
   - すべてのシステムの動作確認
   - 事後検証分析を実施
   - 再発防止のための手順更新

**記憶すべきこと**: 医療システムでは、ソフトウェアの信頼性が患者ケアと安全に直接影響します。

## 長期的な実用性のための開発原則

### 医療グレード開発戦略
- **安定性優先**: ミッションクリティカルな機能では最先端技術より実証済み技術
- **実戦テスト済みライブラリ**: 本番医療システムで豊富な使用実績のあるライブラリを選択
- **モジュラーアーキテクチャ**: システム書き換えなしでコンポーネント交換を可能に
- **API優先設計**: 技術柔軟性のためのフロントエンドとバックエンドの分離
- **包括的テスト**: 医療グレードの信頼性には豊富なテストカバレッジが必要

### 技術選択基準
1. **本番実証**: 実世界の医療システムでの豊富な使用実績が必要
2. **安定性**: 予測可能なアップグレードパスを持つ成熟したAPI
3. **エコシステム**: 迅速な開発のための豊富なライブラリエコシステム
4. **医療準拠**: HIPAA、アクセシビリティ、監査証跡の組み込みサポート
5. **パフォーマンス**: 重要なワークフローで2秒以内の応答時間
6. **コミュニティ**: 強力な長期コミュニティと企業サポート

### バージョン管理プロトコル
- **安定性優先**: 本番展開には安定したLTSバージョンを使用
- **アップグレード前の調査**: 採用前に新バージョンを徹底評価
- **セキュリティ優先**: 即座のセキュリティ更新、計画的な機能更新
- **後方互換性**: 技術進歩中の互換性維持
- **ドキュメント**: すべての技術決定と根拠の完全な文書化

### 医療システム技術監視
- **セキュリティ重視レビュー**: セキュリティパッチと更新の即座の評価
- **四半期安定性評価**: システムパフォーマンスと安定性メトリクスのレビュー
- **年次技術ロードマップ**: 主要アップグレードの保守的計画
- **医療コミュニティ参加**: 医療ITと規制の議論への参加
- **保守的アップグレードアプローチ**: 主要技術変更の最低6ヶ月評価期間

### コード品質とエラーチェックプロトコル

**必須: コミットや展開前に常にリンティングと型チェックを実行**

#### フロントエンド品質チェック（必須）
```bash
# 型チェック - ゼロエラーで合格必須
npm run type-check

# リンティング - ゼロエラーで合格必須（警告は許容）
npm run lint

# ビルド検証 - 正常完了必須
npm run build
```

#### 開発ワークフロー標準
1. **すべてのコミット前**: すべての品質チェックを実行
2. **すべてのプルリクエスト前**: クリーンビルドと型チェックを確保
3. **エラー許容度**: TypeScriptエラーゼロ、未使用型定義のESLint警告は許容
4. **医療安全**: 患者データや医療ワークフローに影響する可能性のあるエラーは即座に修正

#### 修正すべき一般的なエラーパターン
- **未使用インポート**: コードをクリーンに保つためすべての未使用インポートを削除
- **型安全**: すべてのTypeScriptエラー、特にオプショナルチェーン問題を修正
- **型注釈の欠如**: 関数パラメータと戻り値に適切な型注釈を追加
- **不正な型使用**: 列挙値型には`typeof EnumName[keyof typeof EnumName]`を使用

#### 品質チェックを使用するタイミング
- **アクティブ開発中**: コーディング中に頻繁にチェック
- **休憩前**: コードから離れる前に常にチェックを実行
- **大きな変更後**: 大幅なリファクタリング後の完全品質チェック
- **展開前**: 本番展開前の完全検証

**記憶すべきこと**: 医療システムでは、コード品質が患者の安全に直接影響します。品質チェックを決してスキップしないでください。

## プロジェクトビジョンと哲学

### オープンソースイノベーション
- **コミュニティ主導**: GitHub中心の協働開発
- **開発者フレンドリー**: 理解、変更、拡張が容易
- **透明性**: オープンな意思決定と開発プロセス
- **知識共有**: 完全なドキュメントと教育リソース

### AI支援開発環境
- **ローカルLLM統合**: オンプレミスAI支援のためのOllama
- **バイブコーディング**: LLMサポートによる自律開発ワークフロー
- **サンドボックス環境**: 実験的機能の安全なテスト環境
- **継続学習**: 開発パターンと医療ワークフローからAIが学習

### ヘルスケアイノベーションプラットフォーム
- **研究協力**: 学術・産業パートナーシップフレームワーク
- **イノベーションラボ**: 実験的機能開発環境
- **グローバルヘルスインパクト**: 世界的な医療改善への貢献
- **持続可能性**: 環境に配慮した開発実践

## 開発哲学

### テスト駆動エクセレンス
- **包括的テスト**: 全フェーズで85%以上のコードカバレッジ目標
- **医療安全**: 進歩前にすべての機能を徹底テスト
- **パフォーマンス検証**: 応答時間とスケーラビリティベンチマーク
- **準拠検証**: すべてのステップで規制遵守

### モジュラーアーキテクチャ
- **マイクロサービス設計**: 独立したスケーラブルなサービスコンポーネント
- **プラグインシステム**: カスタム機能のための拡張可能アーキテクチャ
- **標準準拠**: FHIR、SS-MIX2、国際標準
- **レガシー統合**: 既存システムとのシームレス接続

### ローカルファーストアプローチ
- **オンプレミス展開**: 医療データの完全なローカル制御
- **オフライン耐性**: 災害耐性動作機能
- **プライバシーバイデザイン**: データがローカル環境を離れない
- **エッジコンピューティング**: パフォーマンスとプライバシーのためのローカル処理

## バックエンドアーキテクチャ決定

### SQLModel統合（2025年）
**決定**: 従来のSQLAlchemyからSQLModelに移行し、統一データレイヤーを実現

**根拠**:
- **単一の真実の源**: SQLModelはPydanticスキーマとSQLAlchemyモデルを結合
- **型安全**: Python 3.11+での完全なTypeScriptスタイル型ヒント
- **FastAPIネイティブ**: FastAPI作者のtiangolo氏による完璧な統合のため作成
- **開発者体験**: コード重複を減らし保守性を向上
- **医療データ整合性**: 患者データの強化された検証とシリアライゼーション

**実装**:
```python
# 従来のアプローチ（置き換え済み）
class Patient(Base):          # SQLAlchemyモデル
class PatientCreate(BaseModel):  # Pydanticスキーマ
class PatientResponse(BaseModel): # 別のスキーマ

# SQLModelアプローチ（現在）
class PatientBase(SQLModel):     # 共有ベース
class Patient(PatientBase, table=True):  # データベースモデル
class PatientCreate(PatientBase):        # 入力スキーマ
class PatientResponse(PatientBase):      # 出力スキーマ
```

**利点**:
- スキーマ関連コードの60%削減
- APIとデータベース間のシリアライゼーションバグゼロ
- 自動OpenAPIドキュメント生成
- 適切な型ヒントによる強化されたIDE支援

## フロントエンドデザインシステム

### Apple風リキッドグラスUI
**決定**: AppleのHIGとリキッドグラス美学を組み合わせた洗練されたデザインシステムを実装

**デザイン哲学**:
- **医療ファーストUX**: 医療ワークフロー向けに最適化されたすべてのインタラクション
- **エレガントなシンプルさ**: 認知負荷を軽減するクリーンで整理されたインターフェース
- **iPhone風の流動性**: スムーズなアニメーションとレスポンシブなインタラクション
- **プロフェッショナル美学**: SaaSの混乱なしの洗練された視覚階層

**主要コンポーネント**:
- **グラスモーフィズムカード**: 微妙な透明度とバックドロップブラー
- **Appleカラーシステム**: プライマリブルー（#007AFF）、システムグレー、医療ステータスカラー
- **流体アニメーション**: スプリング物理とAppleタイミングカーブ
- **医療コンポーネント**: 臨床コンテキストを持つPatientCard、VitalCard、StatusBadge

**技術実装**:
```typescript
// バックドロップブラーによるグラス効果
.glass-card {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(16px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

// スプリング物理によるスムーズなインタラクション
const buttonAnimation = {
  whileHover: { scale: 1.02, y: -1 },
  whileTap: { scale: 0.98 },
  transition: { type: 'spring', stiffness: 400, damping: 17 }
};
```

**パフォーマンス標準**:
- 初期読み込み: 2秒以内
- ページ遷移: 300ms以内
- フォームインタラクション: 100ms応答時間
- 検索結果: 500ms以内

**ドキュメント**: 完全な仕様については`/docs/architecture/design-system.md`を参照

## 重要な注意事項

- これは日本の医療規制への厳格な準拠を要求する医療システムです
- 患者データ処理に関するすべての変更は法的要件を考慮する必要があります
- パフォーマンスは重要です（目標: 2秒以内の応答時間）
- システムは災害シナリオでのオフライン動作をサポートする必要があります
- 多言語サポート（日本語主、英語副）が必要です
- **イノベーション焦点**: このプロジェクトは最先端医療AIのテストサンドボックスとして機能
- **コミュニティインパクト**: グローバルなオープンソース医療技術の進歩を目的として設計

## 開発フェーズ概要

プロジェクトは6段階の開発アプローチに従い、各フェーズで堅牢でテストされた機能を構築します：

1. **フェーズ1（4-6週間）**: 基盤とPoC - Docker環境、コアMVP、ローカルLLM統合
2. **フェーズ2（6-8週間）**: コア機能 - 処方箋管理、検査オーダー、強化AI
3. **フェーズ3（8-10週間）**: セキュリティとマルチユーザー - 認証、監査ログ、ORCA準備
4. **フェーズ4（10-12週間）**: ORCA統合 - 完全な日本請求システム統合
5. **フェーズ5（12-14週間）**: 標準とAI - FHIR、SS-MIX2、高度臨床AI
6. **フェーズ6（16-20週間）**: イノベーションラボ - 研究プラットフォーム、量子コンピューティング、グローバルヘルス

## 開発の次のステップ

1. **環境セットアップ**: Docker-compose開発環境の作成
2. **基盤アーキテクチャ**: FastAPI + Next.js + PostgreSQLスタックの確立
3. **ローカルLLM統合**: 開発支援のためのOllamaセットアップ
4. **テストフレームワーク**: 初日からの包括的テストの実装
5. **コミュニティセットアップ**: 貢献ガイドラインとドキュメントの準備 